# render.yaml - VERSIÓN SIMPLIFICADA
services:
  - type: web
    name: laravel-backend
    env: php
    region: ohio
    plan: free
    buildCommand: |
      # 1. Instalar dependencias sin dev
      composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
      
      # 2. Copiar archivo de entorno de producción
      if [ -f .env.production ]; then
        cp .env.production .env
      fi
      
      # 3. Generar clave de aplicación si no existe
      if ! grep -q "APP_KEY=base64:" .env 2>/dev/null; then
        php artisan key:generate --force --no-interaction
      fi
      
      # 4. Limpiar y optimizar cache
      php artisan config:clear
      php artisan cache:clear
      php artisan view:clear
      
      # 5. Optimizar para producción
      php artisan config:cache
      php artisan route:cache
      php artisan view:cache
      
      # 6. Ejecutar migraciones (SOLO si no hay datos importantes)
      # php artisan migrate --force --no-interaction
      
    startCommand: |
      # Iniciar servidor PHP en el puerto asignado por Render
      php -S 0.0.0.0:$PORT -t public
      
    # Variables de entorno MÍNIMAS requeridas
    envVars:
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: false
      - key: LOG_CHANNEL
        value: stderr
      - key: APP_KEY
        value: base64:gEhNfQY0HYMVWMqjw8taJPH10ly/QiePhYwi7X59up0=
    
    # Configuración de salud
    healthCheckPath: /
    initialDelaySec: 60
    
    # Auto despliegue
    autoDeploy: true
    branch: main